<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="mybatis_bbs">
	<typeAlias alias="bbsDTO" type="kr.co.mybatis.bbs.BbsDTO" />

	<update id="insert" parameterClass="bbsDTO">
		insert into mybatis_bbs(bbsno,wname,subject,content,passwd,grpno,ip,regdt)
		values((select ifnull(max(bbsno),0)+1 from mybatis_bbs as TB),#wname#,#subject#,#content#,#passwd#,(select
		ifnull(max(bbsno),0)+1 from mybatis_bbs as TB),#ip#,now())
	</update>

	<select id="list" parameterClass="Map" resultClass="bbsDTO">

				select bbsno, wname, subject, date_format(regdt, '%Y-%m-%d') as regdt, readcnt, indent
				from mybatis_bbs
				<dynamic prepend="where">
					<isEqual property="col" compareValue="wname">
						wname LIKE CONCAT('%',#word#,'%')
					</isEqual>
					<isEqual property="col" compareValue="subject">
						subject LIKE CONCAT('%',#word#,'%')	
					</isEqual>
					<isEqual property="col" compareValue="content">
						content LIKE CONCAT('%',#word#,'%')			
					</isEqual>
					<isEqual property="col" compareValue="subject_content">
						subject LIKE CONCAT('%',#word#,'%')
						or
						content LIKE CONCAT('%',#word#,'%')			
					</isEqual>
				</dynamic>
				order by grpno DESC, ansnum ASC
				limit #sno#, #numPerPage# 
				
	</select>
	
	<select id="total"  parameterClass="Map" resultClass="Integer">
		select count(*) as cnt
		from mybatis_bbs
		<dynamic prepend="where">
					<isEqual property="col" compareValue="wname">
						wname LIKE CONCAT('%',#word#,'%')		
					</isEqual>
					<isEqual property="col" compareValue="subject">
						subject LIKE CONCAT('%',#word#,'%')			
					</isEqual>
					<isEqual property="col" compareValue="content">
						content LIKE CONCAT('%',#word#,'%')				
					</isEqual>
					<isEqual property="col" compareValue="subject_content">
						subject LIKE CONCAT('%',#word#,'%')
						or
						content LIKE CONCAT('%',#word#,'%')					
					</isEqual>
		</dynamic>
	</select>
	
	<update id ="readcount"  parameterClass="int">
		update mybatis_bbs	
		set readcnt = readcnt + 1
		where bbsno = #bbsno#
	</update>
	
	<select id ="read"  parameterClass="int" resultClass="bbsDTO">
		select bbsno, wname, subject, content, regdt, readcnt, passwd, grpno, ip
		from mybatis_bbs
		where bbsno = #bbsno#
	</select>
	
	<select id = "checkpw"   parameterClass="bbsDTO"  resultClass="Integer">
		select count(*) as cnt
		from mybatis_bbs
		where bbsno = #bbsno# and passwd = #passwd#
	</select>
	
	<select id ="checkGrpno" parameterClass="int" resultClass="Integer">
		select count(*)
		from mybatis_bbs
		where grpno=#grpno#
	</select>
	
	<select id ="passwdCheck" parameterClass="Map" resultClass="Integer">
		select count(*)
		from mybatis_bbs
		where passwd = #passwd# and bbsno = #bbsno#
	</select>
	
	<update id="delete" parameterClass="int">
		delete from mybatis_bbs
		where bbsno = #bbsno#
	</update>
	
	<select id="readReply"  parameterClass="int" resultClass="bbsDTO">
		select bbsno, wname, subject, grpno, ansnum, indent
		from mybatis_bbs
		where bbsno=#bbsno#
	</select>
	
	<update id="upansnum" parameterClass="Map">
		update mybatis_bbs
		set ansnum = ansnum+1
		where grpno = #grpno# and ansnum > #ansnum#
	</update>
	
	<update id="reply" parameterClass="bbsDTO">
		insert into mybatis_bbs(bbsno, wname, passwd, subject, content, regdt, grpno, indent, ansnum, ip)
		values((select ifnull(max(bbsno),0)+1 from mybatis_bbs as TB), #wname#, #passwd#, #subject#, #content#, now(), #grpno#, #indent#+1, #ansnum#+1, #ip#)
	</update>
	
	<update id="update" parameterClass="bbsDTO">
		update mybatis_bbs
		set wname=#wname#, subject=#subject#, content=#content#
		where bbsno = #bbsno#
	</update>
	

</sqlMap>